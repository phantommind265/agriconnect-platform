{% set role = current_user.role if current_user.is_authenticated else 'guest' %}

<!DOCTYPE html><html lang="{{ g.get('lang', 'en') }}" class="h-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}agriconnect{% endblock %}</title>
  <meta name="description" content="AgriConnect â€“ connecting farmers, extension workers, and markets." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='images/icon.png') }}" />{% block extra_head %}{% endblock %}

  <style>
    :root{
      --ag-primary: #16a34a; /* green-600 */
      --ag-primary-600:#16a34a; --ag-primary-700:#15803d; --ag-primary-50:#f0fdf4;
      --ag-bg:#0b1220; /* dark base */
      --ag-card: rgba(255,255,255,.75);
    }
    html,body{height:100%}
    body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: #064e3b; color:#e5e7eb}
    .navbar{backdrop-filter:saturate(160%) blur(10px); background: rgba(2,6,23,.6)!important}
    .brand-logo{height:34px;width:auto}
    .nav-link, .navbar-brand{color:#e5e7eb!important}
    .nav-link.active{color:var(--ag-primary)!important}
    .btn-primary{--bs-btn-bg:var(--ag-primary);--bs-btn-border-color:var(--ag-primary);--bs-btn-hover-bg:var(--ag-primary-700)}
    .ag-card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:16px}
    .ag-shadow{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .badge-role{background: linear-gradient(90deg, var(--ag-primary), #22c55e)}
    a{ text-decoration: none }
    .footer{border-top:1px solid rgba(255,255,255,.08)}
    .search-input{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); color:#fff}
    .search-input::placeholder{color:#9ca3af}
    .dropdown-menu{background:#0b1220; border:1px solid rgba(255,255,255,.08)}
    .dropdown-item{color:#e5e7eb}
    .dropdown-item:hover{background:rgba(255,255,255,.06)}
    .toast-container{z-index:1080}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.2)}
    .sidebar{min-width: 240px}
    .ag-divider{border-color: rgba(255,255,255,.08)!important}
    .lang-flag{width:18px;height:18px;border-radius:50%;object-fit:cover;margin-right:.4rem}
    .toggle{cursor:pointer}
    /* Responsive helpers */
    @media (max-width: 991px){
      .search-desktop{display:none}
    }
  </style></head>
<body class="d-flex flex-column h-100">
  <!-- Top Navbar -->
  <nav class="navbar navbar-expand-lg fixed-top border-bottom ag-divider">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <img class="brand-logo" src="{{ url_for('static', filename='images/icon.png') }}" alt="AgriConnect" />
        <span class="fw-semibold">agriconnect</span>
        {% if current_user.is_authenticated %}
        <span class="badge badge-role ms-2">{{ role|title }}</span>
        {% endif %}
      </a><form class="d-none d-lg-flex ms-3 flex-grow-1" role="search" method="get">
    <div class="input-group search-desktop" style="max-width:640px;">
      <span class="input-group-text bg-transparent border-0 text-secondary"><i class="fa-solid fa-magnifying-glass"></i></span>
      <input class="form-control search-input" type="search" placeholder="Search crops, prices, farmers, postsâ€¦" name="q" />
    </div>
  </form>

  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navMain">
    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-3">
      <li class="nav-item"><a class="nav-link {% if request.endpoint=='main.index' %}active{% endif %}" href="#"><i class="fa-solid fa-house"></i> Home</a></li>
      <li class="nav-item"><a class="nav-link {% if 'market' in request.endpoint %}active{% endif %}" href="{{ url_for('marketplace.market_page') }}"><i class="fa-solid fa-store"></i> Marketplace</a></li>
      <li class="nav-item"><a class="nav-link {% if 'prices' in request.endpoint %}active{% endif %}" href="{{ url_for('market.market_prices') }}"><i class="fa-solid fa-chart-line"></i> Price Trends</a></li>
      <li class="nav-item"><a class="nav-link {% if 'agrishare' in request.endpoint %}active{% endif %}" href="{{ url_for('agrishare.create_share_session') }}"><i class="fa-solid fa-handshake-angle"></i> AgriShare</a></li>
      <li class="nav-item"><a class="nav-link {% if 'forum' in request.endpoint %}active{% endif %}" href="{{ url_for('forum.forum_home') }}"><i class="fa-solid fa-comments"></i> Forum</a></li>
      <li class="nav-item"><a class="nav-link {% if 'messages' in request.endpoint %}active{% endif %}" href="{{ url_for('message_bp.users_list') }}"><i class="fa-solid fa-envelope"></i> Messaging</a></li>
      {% if current_user.is_authenticated and role in ['extension_worker','admin'] %}
        <li class="nav-item"><a class="nav-link {% if 'ext' in request.endpoint %}active{% endif %}" href="{{ url_for('auth.extension_dashboard') }}"><i class="fa-solid fa-briefcase"></i> Extension</a></li>
      {% endif %}
      {% if current_user.is_authenticated and role == 'admin' %}
        <li class="nav-item"><a class="nav-link {% if 'admin' in request.endpoint %}active{% endif %}" href="{{ url_for('auth.admin_dashboard') }}"><i class="fa-solid fa-shield"></i> Admin</a></li>
      {% endif %}
    </ul>

    <ul class="navbar-nav mb-2 mb-lg-0 align-items-lg-center">
      <!-- AI Assistant trigger -->
      <!--
      <li class="nav-item me-lg-2">
        <button class="btn btn-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#aiAssistant"><i class="fa-solid fa-robot me-1"></i> AI</button>
      </li>
      -->
      <li class="nav-item me-lg-2">
	      <button class="btn btn-primary rounded-pill px-3"><a href="{{ url_for('ai.ai_assistant') }}"><i class="fa-solid fa-robot me-1"></i> AI</button>
      </li>


      <!-- Language Switcher -->
      <!--
      <li class="nav-item dropdown me-lg-2">
        <a class="nav-link dropdown-toggle" href="#" id="langMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fa-solid fa-globe"></i> {{ session.get('language','en')|upper }}
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langMenu">
          <li>
            <form method="post" class="px-3 py-2">
              {{ csrf_token() if csrf_token is defined }}
              <select name="language" class="form-select form-select-sm mb-2">
                <option value="en" {% if session.get('language','en')=='en' %}selected{% endif %}>English</option>
                <option value="ny" {% if session.get('language')=='ny' %}selected{% endif %}>Chichewa</option>
              </select>
              <button class="btn btn-sm btn-outline-light w-100" type="submit">Apply</button>
            </form>
          </li>
        </ul>
      </li>
      -->

      {% if current_user.is_authenticated %}
      <!-- Notifications -->
    <li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle position-relative" href="#" role="button" data-bs-toggle="dropdown">
    ðŸ””
    {% if notif_unread > 0 %}
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
      {{ notif_unread }}
    </span>
    {% endif %}
  </a>
  <ul class="dropdown-menu dropdown-menu-end">
    {% if recent_notifs %}
      {% for n in recent_notifs %}
      <li>
        <a class="dropdown-item" href="{{ n['link'] or '#' }}">
          <strong>{{ n['title'] }}</strong><br>
          <small>{{ n['message']|truncate(40) }}</small>
        </a>
      </li>
      {% endfor %}
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item text-primary" href="{{ url_for('notifications.all_notifications') }}">View All</a></li>
    {% else %}
      <li><span class="dropdown-item">No new notifications</span></li>
    {% endif %}
  </ul>
</li>

      <!-- Profile -->
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
          <img class="avatar" src="{{ current_user.profile_pic_url or url_for('static', filename='images/icon.png') }}" alt="avatar" />
          <span class="d-none d-lg-inline">{{ current_user.username }}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
          <li><a class="dropdown-item" href="{{ url_for('farmer.view_profile', user_id=current_user.id) }}"><i class="fa-solid fa-user"></i> Profile</a></li>
          <li><a class="dropdown-item" href="#"><i class="fa-solid fa-gear"></i> Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
      </li>
      {% else %}
      <li class="nav-item"><a class="btn btn-outline-light ms-lg-2" href="{{ url_for('auth.login') }}">Login</a></li>
      <li class="nav-item"><a class="btn btn-primary ms-lg-2" href="{{ url_for('auth.register') }}">Sign Up</a></li>
      {% endif %}
    </ul>
  </div>
</div>

  </nav>  <!-- Spacer for fixed navbar -->  <div style="height:70px"></div>  <!-- Breadcrumbs (optional) -->{% block breadcrumbs %}{% endblock %}

  <main class="flex-shrink-0">
    <div class="container-fluid">
      <div class="row g-3">
        {% block layout %}
        <!-- Optional sidebar slot -->
        {% if self.sidebar() %}
          <aside class="col-12 col-lg-3">
            <div class="ag-card ag-shadow p-3 sticky-top" style="top:86px">
              {% block sidebar %}{% endblock %}
            </div>
          </aside>
          <section class="col-12 col-lg-9">
            {% block content2 %}{% endblock %}
          </section>
        {% else %}
          <section class="col-12">
		  {% block content %}<br><br>{% endblock %}
          </section>
        {% endif %}
        {% endblock %}
      </div>
    </div>
  </main>  <!-- Footer -->  <footer class="footer mt-auto py-4">
    <div class="container d-flex flex-wrap justify-content-between align-items-center small text-secondary">
      <div>
        Â© {{  now().year if now is defined else 2025 }} agriconnect Â· <a href="{{ url_for('auth.about_page') }}" class="link-light">About</a> Â· <a href="{{ url_for('auth.contact') }}" class="link-light">Contact</a>
      </div>
      <div class="d-flex align-items-center gap-3">
        <label class="toggle small"><input id="darkToggle" type="checkbox" class="form-check-input me-1"> Dark mode</label>
        <a class="link-light" href="#">Terms</a>
        <a class="link-light" href="#">Privacy</a>
      </div>
    </div>
  </footer>  <!-- Flash messages -->  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="toast text-bg-{{ 'success' if category=='success' else ('danger' if category=='error' else 'dark') }}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-header">
              <strong class="me-auto">agriconnect</strong>
              <small>Just now</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">{{ message }}</div>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>  <!-- AI Assistant Modal -->  <div class="modal fade" id="aiAssistant" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content ag-card">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-robot me-2"></i>AgriConnect AI</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('ai.ai_assistant') }}" method="post" id="aiForm">
            {{ csrf_token() if csrf_token is defined }}
            <div class="mb-2">
              <label class="form-label">Ask anything about crops, prices, weather, or best practices</label>
              <textarea class="form-control" name="prompt" rows="3" placeholder="e.g., Suggest profitable crops for Mchinji this season"></textarea>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <select class="form-select" name="context_role" style="max-width:240px">
                <option value="auto">Auto-detect role ({{ role|title }})</option>
                <option value="farmer">Farmer context</option>
                <option value="extension">Extension worker context</option>
                <option value="admin">Admin context</option>
              </select>
              <button class="btn btn-primary" type="submit"><i class="fa-solid fa-paper-plane"></i> Ask</button>
            </div>
          </form>
          <div id="aiResult" class="mt-3 small text-secondary">
            <!-- You can inject AI response here via HTMX/Fetch -->
          </div>
        </div>
      </div>
    </div>
  </div>  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>  <script>
    // Activate toasts
    document.querySelectorAll('.toast').forEach(t => new bootstrap.Toast(t).show());

    // Dark mode toggle (simple)
    const toggle = document.getElementById('darkToggle');
    const root = document.documentElement;
    const THEME_KEY = 'ag-theme';
    const saved = localStorage.getItem(THEME_KEY) || 'dark';
    applyTheme(saved);
    toggle.checked = saved === 'dark';
    toggle.addEventListener('change', () => {
      const mode = toggle.checked ? 'dark' : 'light';
      applyTheme(mode);
      localStorage.setItem(THEME_KEY, mode);
    });
    function applyTheme(mode){
      if(mode==='light'){
        document.body.style.background = '#f8fafc';
        document.body.style.color = '#0f172a';
        document.querySelectorAll('.navbar').forEach(n=>n.style.background='rgba(255,255,255,.85)');
      }else{
        document.body.style.background = '#0f172a';
        document.body.style.color = '#e5e7eb';
        document.querySelectorAll('.navbar').forEach(n=>n.style.background='rgba(2,6,23,.6)');
      }
    }

    // Optional: fetch AI response without page reload
    const aiForm = document.getElementById('aiForm');
    if(aiForm){
      aiForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const formData = new FormData(aiForm);
        const res = await fetch(aiForm.action, {method:'POST', body:formData, headers:{'X-Requested-With':'fetch'}});
        const html = await res.text();
        document.getElementById('aiResult').innerHTML = html;
      });
    }
  </script>{% block extra_scripts %}{% endblock %}

</body>
</html>
